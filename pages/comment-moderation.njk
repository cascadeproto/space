---
title: Comment Moderation
permalink: "/secret-moderation-hole/"
eleventyExcludeFromCollections: true
layout: raw.njk
---

<h1>Comment Moderation</h1>

<form class="flow comment-moderation" name="approved-comments" netlify netlify-honeypot="sweetgoods">
    <div id="totalwaiting"></div>
    <p class="visually-hidden">Don't fill this out if you're human:
        <input type="text" name="sweetgoods" />
    </p>
    <p><label>Comment ID:
        <input type="text" name="comment_id" />
    </label></p>
    <p><label>IP address:
        <input type="text" name="commenter_ip" />
    </label></p>
    <p><label>User Agent:
        <input type="text" name="commenter_ua" />
    </label></p>
    <p><label>Time Posted:
        <input type="text" name="time" />
    </label></p>
    <p><label>Page:
        <input type="text" name="path" />
    </label></p>
    <p><label>Comment parent ID: <span id="comment-parent"></span>
        <input type="text" name="parent" />
    </label></p>
    <p id="comment-parent"></p>
    <p><label>Name:
        <input type="text" name="name" />
    </label></p>
    <p><label>URL:
        <input type="text" name="url" />
    </label></p>
    <p><label>Avatar:
        <input type="text" name="avatar" />
    </label></p>
    <p><label>Comment:
        <textarea name="comment"></textarea>
    </label></p>
    <p><label>Password:
        <input type="password" name="pass" />
    </label></p>
    
    <p id="buttons">
        <button id="approve-comment" type="submit">Approve</button> • • • 
        <a href="https://app.netlify.com/sites/precious-brioche-483ced/forms/66b6335471d4a60008fa2e4f">Delete</button>
    </p>
</form>

<style>
    .comment-moderation label {
        display: block;
        font-weight: bold;
    }
    .comment-moderation input,
    .comment-moderation textarea {
        display: block;
        width: 100%;
        padding: .3em;
        font-weight: normal;
    }
    .comment-moderation textarea {
        min-height: 15em;
    }
    .comment-moderation button {
        background-color: blue;
        padding: .2em .5em;
        border-radius: 4px;
        border: 1px solid #00000044;
        color: white;
        font-weight: bold;
    }
    #delete-comment { background-color: red; }
    #approve-comment { background-color: green; }
</style>
<script type="module">
    console.log('Loading...');
    const modform = document.querySelector('[name="approved-comments"]');
    const site_id = '71197ba4-a1bc-4651-9025-c10c57df7876';
    const api_token = 'nfp_8uXZqHAe9faqZ19JnwUhXJ9MC3RBwsGV50fb';
    const new_comment_form_id = '66b6335471d4a60008fa2e4f';
    const api_root = 'https://api.netlify.com/api/v1';
    const params = new URLSearchParams(document.location.search);
    const review_id = params.get('comment');

    const response = await fetch(`${api_root}/forms/${new_comment_form_id}/submissions`, {
        headers: {
            'User-Agent': 'Comment Moderation using Forms API',
            'Authorization': `Bearer ${api_token}`
        }
    });

    if (response.ok) {
        const data = await response.json();
        console.log(data);
        let currentComment = data.find(o => o.data.commentId === review_id);
        console.log(currentComment);

        // Fill UI
        let plural = data.length == 1 ? '' : 's';
        let queueHTML = '';
        for (let i = 0; i < data.length; i++) {
            queueHTML = queueHTML + `<li><a href="/secret-moderation-hole/?comment=${data[i].data.commentId}">By ${data[i].data.name} on ${data[i].data.path} at ${data[i].created_at}</a></li>`;
        }
        document.querySelector('#totalwaiting').innerHTML = `<p>There's ${data.length} comment${plural} awaiting moderation:</p><ul>${queueHTML}</ul>`;
        document.querySelector('form [name="comment_id"]').value = currentComment.data.commentId;
        document.querySelector('form [name="commenter_ip"]').value = currentComment.data.ip;
        document.querySelector('form [name="commenter_ua"]').value = currentComment.data.user_agent;
        document.querySelector('form [name="time"]').value = currentComment.created_at;
        document.querySelector('form [name="path"]').value = currentComment.data.path;
        document.querySelector('form [name="parent"]').value = currentComment.data.parent;
        document.querySelector('form [name="name"]').value = currentComment.data.name;
        document.querySelector('form [name="url"]').value = currentComment.data.url;
        document.querySelector('form [name="avatar"]').value = currentComment.data.avatar;
        document.querySelector('form [name="comment"]').innerHTML = currentComment.data.comment;
        // Approve button is default HTML behavior
        // build hook url for new comments: https://api.netlify.com/build_hooks/66b6a49ba5564d902a2675e4
    } else {
        console.warn(response);
    }
</script>